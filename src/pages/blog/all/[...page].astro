---
export const prerender = false

import BlogLayout from '@/layouts/BlogLayout.astro'
import ArticlesList from '@/components/articles/ArticlesList.astro'
import BlogAboutCallout from '@/components/articles/BlogAboutCallout.astro'
import { getRecentPosts } from '@/lib/getRecentPosts';
import { getEnv } from '@/middleware'

// Parse page number from URL params
const pageParam = Astro.params.page;
const currentPage = pageParam ? parseInt(pageParam, 10) : 1;
const pageSize = Number(getEnv('ARTICLES_PER_PAGE')) || 25;
const offset = (currentPage - 1) * pageSize;

const { articles, totalPages } = await getRecentPosts({ count: pageSize, offset });

const page = {
  data: articles,
  currentPage,
  lastPage: totalPages,
};

// The browser should always check freshness
Astro.response.headers.set("cache-control", "public, max-age=0, must-revalidate");

// The CDN should cache for a year, but revalidate if the cache tag changes
Astro.response.headers.set("netlify-cdn-cache-control", "s-maxage=31536000");

// Tag the page with the content type
Astro.response.headers.set("netlify-cache-tag", "blog/all");
---

<BlogLayout title="Blog - Adam Fortuna" description="Every blog post I've written across a few different sites">
  <h1 class="font-handwriting text-6xl text-blue-700 mb-2">Blog</h1>
  <BlogAboutCallout />
  <ArticlesList showSeparator={true} articles={page.data} page={page.currentPage} totalPages={page.lastPage} url="/blog/all" />
</BlogLayout>