---
export const prerender = false

import BlogLayout from '@/layouts/BlogLayout.astro'
import ArticlesList from '@/components/articles/ArticlesList.astro'
import BlogAboutCallout from '@/components/articles/BlogAboutCallout.astro'
import { getRecentPosts } from '@/lib/getRecentPosts'
import type { WordpressClientIdentifier } from "@/types"
import { getEnv } from '@/middleware'

const titleize = (category: WordpressClientIdentifier | undefined) => {
  switch (category) {
    case 'minafi':
      return 'Minafi'
    case 'hardcover':
      return 'Hardcover'
    default:
      return 'Adam Fortuna'
  }
}

const projectParam = Astro.params.project as WordpressClientIdentifier;
const validProjects: WordpressClientIdentifier[] = ['adamfortuna', 'minafi', 'hardcover'];
if (!validProjects.includes(projectParam)) {
  return new Response(null, { status: 404, statusText: 'Project not found' });
}

const pageParam = Astro.params.page;
const currentPage = pageParam ? parseInt(pageParam, 10) : 1;
const pageSize = Number(getEnv('ARTICLES_PER_PAGE')) || 25;
const offset = (currentPage - 1) * pageSize;

const { articles, totalPages } = await getRecentPosts({
  count: pageSize,
  offset,
  projects: [projectParam]
});

const page = {
  data: articles,
  currentPage,
  lastPage: totalPages,
};

const project = projectParam;
const projectTitle = titleize(project)

// The browser should always check freshness
Astro.response.headers.set("cache-control", "public, max-age=0, must-revalidate");

// The CDN should cache for a year, but revalidate if the cache tag changes
Astro.response.headers.set("netlify-cdn-cache-control", "s-maxage=31536000");

// Tag the page with the content type
Astro.response.headers.set("netlify-cache-tag", `blog/projects/${project}`);
---

<BlogLayout title="Blog - Adam Fortuna" description="Every blog post I've written across a few different sites">
  <p class="font-handwriting text-2xl md:text-4xl lg:text-6xl text-blue-700 mb-2 flex flex-wrap items-baseline">
    <span>
      <a href="/blog" class="underline hover:no-underline">
        Blog
      </a>
    </span>
    <span class="text-2xl mx-2">/</span>
    <span>
      <a href="/blog/projects" class="underline hover:no-underline">
        Projects
      </a>
    </span>
    </span>
    <span class="text-2xl mx-2">/</span>
    <span>{projectTitle}</span>
  </p>
  <BlogAboutCallout />
  <ArticlesList showSeparator={true} articles={page.data} page={page.currentPage} totalPages={page.lastPage} url={`/blog/projects/${project}`} />
</BlogLayout>